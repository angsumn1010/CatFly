<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Awards Display</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    th { background-color: #f72929; color: white; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .filter-container { margin: 15px 0; }
    select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>Awards Issued</h1>
  <p><a href="/awards">Awards CRUD</a> | <a href="/">Home</a></p>

  <div class="filter-container">
    <label for="event-filter">Filter by event:</label>
    <select id="event-filter" aria-label="Filter awards by event">
      <option value="">-- All Events --</option>
      <% if (events && events.length) { %>
        <% events.forEach(function(ev) { %>
          <option value="<%= ev.id %>" <%= (String(ev.id) === String(selectedEvent)) ? 'selected' : '' %>>
            <%= ev.title %>
          </option>
        <% }); %>
      <% } %>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>Award ID</th>
        <th>Participant Name</th>
        <th>Email</th>
        <th>Event</th>
        <th>Badge/Cert</th>
        <th>Issue Date</th>
      </tr>
    </thead>
    <tbody id="awards-tbody">
      <% if (awards && awards.length) { %>
        <% awards.forEach(function(award) { %>
          <tr>
            <td><%= award.id %></td>
            <td><%= award.participant_name || 'N/A' %></td>
            <td><%= award.email || 'N/A' %></td>
            <td><%= award.event_title || 'N/A' %></td>
            <td><%= award.badge_name || 'N/A' %></td>
            <td><%= award.issue_date ? award.issue_date.toISOString().split('T')[0] : 'N/A' %></td>
          </tr>
        <% }); %>
      <% } else { %>
        <tr><td colspan="6" style="text-align: center;">No awards found</td></tr>
      <% } %>
    </tbody>
  </table>

  <script>
    (function() {
      const select = document.getElementById('event-filter');
      const tbody = document.getElementById('awards-tbody');

      function esc(s) {
        return String(s || '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[ch]);
      }

      function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        return new Date(dateStr).toISOString().split('T')[0];
      }

      async function loadAwards(eventId) {
        try {
          const url = '/award-service/api' + (eventId ? '?event_id=' + encodeURIComponent(eventId) : '');
          const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!res.ok) throw new Error('Network error');
          const rows = await res.json();

          if (!Array.isArray(rows) || rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No awards found</td></tr>';
            return;
          }

          tbody.innerHTML = rows.map(award => `
            <tr>
              <td>${esc(award.id)}</td>
              <td>${esc(award.participant_name || 'N/A')}</td>
              <td>${esc(award.email || 'N/A')}</td>
              <td>${esc(award.event_title || 'N/A')}</td>
              <td>${esc(award.badge_name || 'N/A')}</td>
              <td>${formatDate(award.issue_date)}</td>
            </tr>
          `).join('');
        } catch (err) {
          console.error('loadAwards error:', err);
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Error loading awards</td></tr>';
        }
      }

      select.addEventListener('change', (e) => {
        e.preventDefault();
        loadAwards(e.target.value);
      });

      if (select.value) loadAwards(select.value);
    })();
  </script>
</body>
</html>