<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Users</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }

    th,
    td {
      text-align: left;
      padding: 8px;
    }

    tr:nth-child(even) {
      background-color: #ece8b9
    }

    th {
      background-color: #f72929;
      color: white;
    }

    .action-links {
      display: inline-block;
      margin-left: 10px;
    }

    .delete-form {
      display: inline;
    }

    .delete-btn {
      background: none;
      border: none;
      color: blue;
      text-decoration: underline;
      cursor: pointer;
      padding: 0;
    }
  </style>
</head>

<body>
  <h2>Participant Management Dashboard</h2>
  <table border="0" cellpadding="0" cellspacing="0">
    <tr>
      <td style="width: 15%; text-align: left;">
        <h3>Select An Event</h3>
      </td>
      <td>
        <form id="event-filter-form">
          <select name="event_id" id="event-select">
            <option value="">-- All events --</option>
            <% if (typeof events !=='undefined' && events.length) { %>
              <% events.forEach(function(event) { %>
                <option value="<%= event.id %>">
                  <%= event.title %>
                </option>
                <% }); %>
                  <% } else { %>
                    <option disabled>No events</option>
                    <% } %>
          </select>
        </form>
      </td>
      <td style="text-align:right;">
        <p><a href="/">Add New Participant</a></p>
      </td>
    </tr>
  </table>

  <div id="users-container">
    <table cellpadding="6" id="users-table">
      <thead>
        <tr>
          <th>Participant Name</th>
          <th>Participant Enterprise Name</th>
          <th>Participant Email</th>
          <th>Participant Phone</th>
          <th style="text-align: center;">Actions</th>
        </tr>
      </thead>
      <tbody id="users-tbody">
        <% if (users && users.length> 0) { %>
          <% users.forEach(function(user) { %>
            <tr>
              <td style="width: 20%;">
                <%= user.name %>
              </td>
              <td style="width: 20%;">
                <%= user.ent_name %>
              </td>
              <td style="width: 20%;">
                <%= user.email %>
              </td>
              <td style="width: 20%;">
                <%= user.phone %>
              </td>
              <td style="text-align: center; width: 10%;">
                <a href="/edit/<%= user.id %>">Edit</a> |
                <form class="delete-form" action="/delete/<%= user.id %>" method="POST"
                  onsubmit="return confirm('Are you sure you want to delete this user?')">
                  <button type="submit" class="delete-btn">Delete</button>
                </form>
              </td>
            </tr>
            <% }) %>
              <% } %>
      </tbody>
    </table>
  </div>

  <script>
    (function ()
    {
      const select = document.getElementById('event-select');
      const usersTbody = document.getElementById('users-tbody');
      const usersContainer = document.getElementById('users-container');

      // Retrieve last selected event from localStorage
      function getLastSelectedEvent()
      {
        return localStorage.getItem('lastSelectedEventId') || '';
      }

      // Save selected event to localStorage
      function saveSelectedEvent(eventId)
      {
        localStorage.setItem('lastSelectedEventId', eventId);
      }

      async function fetchAndRender(eventId)
      {
        const url = '/api/users' + (eventId ? '?event_id=' + encodeURIComponent(eventId) : '');
        try
        {
          const res = await fetch(url);
          if (!res.ok) throw new Error('Network error');
          const users = await res.json();

          // render
          if (!users || users.length === 0)
          {
            usersTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No users found.</td></tr>';
            return;
          }

          const html = users.map(u => `
            <tr>
              <td style="width: 20%;">${escapeHtml(u.name)}</td>
              <td style="width: 20%;">${escapeHtml(u.ent_name || '')}</td>
              <td style="width: 20%;">${escapeHtml(u.email)}</td>
              <td style="width: 20%;">${escapeHtml(u.phone || '')}</td>
              <td style="text-align: center; width: 10%;">
                <a href="/edit/${u.id}">Edit</a> |
                <form class="delete-form" action="/delete/${u.id}" method="POST" onsubmit="return confirm('Are you sure you want to delete this user?')">
                  <button type="submit" class="delete-btn">Delete</button>
                </form>
              </td>
            </tr>
          `).join('');
          usersTbody.innerHTML = html;
        } catch (err)
        {
          console.error(err);
          usersTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Error loading users</td></tr>';
        }
      }

      function escapeHtml(str)
      {
        if (str == null) return '';
        return String(str).replace(/[&<>"']/g, function (m)
        {
          return {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
          }[m];
        });
      }

      // Restore last selected event on page load
      window.addEventListener('load', function ()
      {
        const lastEventId = getLastSelectedEvent();
        if (lastEventId)
        {
          select.value = lastEventId;
          fetchAndRender(lastEventId);
        }
      });

      select.addEventListener('change', function ()
      {
        const eventId = select.value;
        saveSelectedEvent(eventId);
        fetchAndRender(eventId);
      });
    })();
  </script>
</body>

</html>