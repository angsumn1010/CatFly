<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Awards</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }

        th {
            background-color: #f72929;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        a {
            color: #0066cc;
            text-decoration: none;
            margin-right: 10px;
        }

        a:hover {
            text-decoration: underline;
        }

        .actions {
            white-space: nowrap;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #d9534f;
            cursor: pointer;
            text-decoration: underline;
        }

        .delete-form {
            display: inline;
        }

        .filter-container {
            margin: 15px 0;
        }

        select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <h1>Awards Management</h1>
    <p><a href="/awards/new"
            style="background-color: #f72929; color: white; padding: 8px 12px; border-radius: 4px; text-decoration: none;">+
            Create New Award</a></p>

    <div class="filter-container">
        <label for="event-filter">Filter by Event:</label>
        <select id="event-filter">
            <option value="">-- All Events --</option>
            <% if (events && events.length) { %>
                <% events.forEach(function(event) { %>
                    <option value="<%= event.id %>">
                        <%= event.title %>
                    </option>
                    <% }); %>
                        <% } %>
        </select>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Award Name</th>
                <th>Award Type</th>
                <th>Description</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="awards-tbody">
            <% /* initial server-rendered rows kept for no-JS fallback */ %>
            <% if (awards && awards.length) { %>
                <% awards.forEach(function(award) { %>
                    <tr>
                        <td>
                            <%= award.id %>
                        </td>
                        <td>
                            <%= award.award_name %>
                        </td>
                        <td>
                            <%= award.award_type %>
                        </td>
                        <td>
                            <%= award.description %>
                        </td>
                        <td class="actions">
                            <a href="/awards/edit/<%= award.id %>">Edit</a>
                            <form class="delete-form" action="/awards/delete/<%= award.id %>" method="POST"
                                onsubmit="return confirm('Delete this award?')">
                                <button type="submit" class="delete-btn">Delete</button>
                            </form>
                        </td>
                    </tr>
                    <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="5" style="text-align: center;">No awards found</td>
                            </tr>
                            <% } %>
        </tbody>
    </table>

    <script>
        (function () {
            const select = document.getElementById('event-filter');
            const tbody = document.getElementById('awards-tbody');

            function escapeHtml(s) {
                return String(s || '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[ch]);
            }

            async function loadAwards(eventId) {
                try {
                    const url = '/awards/api/awards' + (eventId ? '?event_id=' + encodeURIComponent(eventId) : '');
                    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                    if (!res.ok) throw new Error('Network response was not ok');
                    const rows = await res.json();
                    if (!Array.isArray(rows) || rows.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No records found</td></tr>';
                        return;
                    }
                    const html = rows.map(r => `
            <tr>
              <td>${escapeHtml(r.id)}</td>
              <td>${escapeHtml(r.award_name || r.name || '')}</td>
              <td>${escapeHtml(r.award_type || '')}</td>
              <td>${escapeHtml(r.description || r.ent_name || '')}</td>
              <td class="actions">
                <a href="/awards/edit/${encodeURIComponent(r.id)}">Edit</a>
                <form class="delete-form" action="/awards/delete/${encodeURIComponent(r.id)}" method="POST" onsubmit="return confirm('Delete this item?')">
                  <button type="submit" class="delete-btn">Delete</button>
                </form>
              </td>
            </tr>
          `).join('');
                    tbody.innerHTML = html;
                } catch (err) {
                    console.error('loadAwards error:', err);
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Error loading data</td></tr>';
                }
            }

            // bind without page reload
            select.addEventListener('change', () => loadAwards(select.value));

            // optional: load data for initial selection (if not empty) to reflect server state consistently
            if (select.value) loadAwards(select.value);
        })();
    </script>
</body>

</html>